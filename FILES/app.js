const data =  {
    "livres": [
    {
    "titre": "Les Profs",
    "auteurs": "Pica",
    "isbn": "978-2-1234-5678-9",
    "image": "../Img/bd1.jpg",
    "editeur": "Bamboo Édition",
    "datePublication": "2000",
    "genre": "BD, Comédie",
    "resume": "Des profs tous dingues tentent de sauver une école avec humour et désinvolture.",
    "langue": "Français",
    "nombrePages": 48,
    "disponibilite": "disponible",
    "etat": "Bonne",
    "emplacement": "Rayon BD"
    },
    {
    "titre": "Livingston contra Fumake",
    "auteurs": "Alamy",
    "isbn": "978-1-234-56789-7",
    "image": "../Img/bd3.jpg",
    "editeur": "Éditions Alamy",
    "datePublication": "2005",
    "genre": "BD, Thriller",
    "resume": "Un détective se lance dans une chasse sans merci contre un tueur en série redoutable.",
    "langue": "Français",
    "nombrePages": 200,
    "disponibilite": "disponible",
    "etat": "Usagé",
    "emplacement": "Rayon BD"
    },
    {
    "titre": "Pokémon: Attrapez-les tous !",
    "auteurs": "Hidenori Kusaka",
    "isbn": "978-1-4201-1234-5",
    "image": "../Img/bv1.png",
    "editeur": "Bibliothèque Verte",
    "datePublication": "1997",
    "genre": "Aventure, Jeunesse",
    "resume": "Sacha rêve de devenir le meilleur dresseur de Pokémon.",
    "langue": "Français",
    "nombrePages": 150,
    "disponibilite": "disponible",
    "etat": "Usagé",
    "emplacement": "Rayon Jeunesse"
    },
    {
    "titre": "Les Légendaires",
    "auteurs": "Patrick Sobral",
    "isbn": "978-2-01-201234-5",
    "image": "../Img/bv5.jfif",
    "editeur": "Delcourt",
    "datePublication": "2004",
    "genre": "Fantasy, Jeunesse",
    "resume": "Les aventures de héros devenus enfants après un accident magique.",
    "langue": "Français",
    "nombrePages": 120,
    "disponibilite": "disponible",
    "etat": "Usagé",
    "emplacement": "Rayon Jeunesse"
    },
    {
    "titre": "Une héritière à dompter",
    "auteurs": "Sharon Kendrick",
    "isbn": "978-2-290-12345-6",
    "image": "../Img/harlequin1.jpg",
    "editeur": "Harlequin",
    "datePublication": "2012",
    "genre": "Romance",
    "resume": "Une histoire d'amour passionnante entre une héritière et un homme déterminé à la conquérir.",
    "langue": "Français",
    "nombrePages": 300,
    "disponibilite": "non disponible",
    "etat": "Bonne",
    "emplacement": "Rayon Romance"
    },
    {
    "titre": "Une nuit avec un Grec",
    "auteurs": "Sharon Kendrick",
    "isbn": "978-2-290-23456-7",
    "image": "../Img/harlequin2.jfif",
    "editeur": "Harlequin",
    "datePublication": "2013",
    "genre": "Romance",
    "resume": "Une histoire d'amour entre une Américaine et un riche Grec.",
    "langue": "Français",
    "nombrePages": 320,
    "disponibilite": "disponible",
    "etat": "Bonne",
    "emplacement": "Rayon Romance"
    }
    ]
    };

let staticData = {
    "livres": [
        {
            "titre": "Les Profs",
            "auteurs": "Pica",
            "isbn": "978-2-1234-5678-9",
            "image": "../Img/bd1.jpg",
            "editeur": "Bamboo Édition",
            "datePublication": "2000",
            "genre": "BD, Comédie",
            "resume": "Des profs tous dingues tentent de sauver une école avec humour et désinvolture.",
            "langue": "Français",
            "nombrePages": 48,
            "disponibilite": "disponible",
            "etat": "Bonne",
            "emplacement": "Rayon BD"
        },
        {
            "titre": "Livingston contra Fumake",
            "auteurs": "Alamy",
            "isbn": "978-1-234-56789-7",
            "image": "../Img/bd3.jpg",
            "editeur": "Éditions Alamy",
            "datePublication": "2005",
            "genre": "BD, Thriller",
            "resume": "Un détective se lance dans une chasse sans merci contre un tueur en série redoutable.",
            "langue": "Français",
            "nombrePages": 200,
            "disponibilite": "disponible",
            "etat": "Usagé",
            "emplacement": "Rayon BD"
        },
        {
            "titre": "Pokémon: Attrapez-les tous !",
            "auteurs": "Hidenori Kusaka",
            "isbn": "978-1-4201-1234-5",
            "image": "../Img/bv1.png",
            "editeur": "Bibliothèque Verte",
            "datePublication": "1997",
            "genre": "Aventure, Jeunesse",
            "resume": "Sacha rêve de devenir le meilleur dresseur de Pokémon.",
            "langue": "Français",
            "nombrePages": 150,
            "disponibilite": "disponible",
            "etat": "Usagé",
            "emplacement": "Rayon Jeunesse"
        },
        {
            "titre": "Les Légendaires",
            "auteurs": "Patrick Sobral",
            "isbn": "978-2-01-201234-5",
            "image": "../Img/bv5.jfif",
            "editeur": "Delcourt",
            "datePublication": "2004",
            "genre": "Fantasy, Jeunesse",
            "resume": "Les aventures de héros devenus enfants après un accident magique.",
            "langue": "Français",
            "nombrePages": 120,
            "disponibilite": "disponible",
            "etat": "Usagé",
            "emplacement": "Rayon Jeunesse"
        },
        {
            "titre": "Une héritière à dompter",
            "auteurs": "Sharon Kendrick",
            "isbn": "978-2-290-12345-6",
            "image": "../Img/harlequin1.jpg",
            "editeur": "Harlequin",
            "datePublication": "2012",
            "genre": "Romance",
            "resume": "Une histoire d'amour passionnante entre une héritière et un homme déterminé à la conquérir.",
            "langue": "Français",
            "nombrePages": 300,
            "disponibilite": "non disponible",
            "etat": "Bonne",
            "emplacement": "Rayon Romance"
        },
        {
            "titre": "Une nuit avec un Grec",
            "auteurs": "Sharon Kendrick",
            "isbn": "978-2-290-23456-7",
            "image": "../Img/harlequin2.jfif",
            "editeur": "Harlequin",
            "datePublication": "2013",
            "genre": "Romance",
            "resume": "Une histoire d'amour entre une Américaine et un riche Grec.",
            "langue": "Français",
            "nombrePages": 320,
            "disponibilite": "disponible",
            "etat": "Bonne",
            "emplacement": "Rayon Romance"
        }
    ]
};


async function chargerDonnees() {
    try {
        let response = await fetch('./data.json');
        if (!response.ok) {
            throw new Error('Erreur de chargement des données');
        }
        let jsonData = await response.json(); 
        return jsonData; 
    } catch (error) {
        console.error('Erreur de chargement des données depuis data.json :', error);
        return staticData; 
    }
}


chargerDonnees()
    .then(resultat => {
        data.livres = resultat.livres; 
        console.log('Données chargées avec succès :', data);

    })
    .catch(error => {
        console.error('Erreur lors du chargement des données :', error);

    });



if (!localStorage.getItem('livres')) {
    localStorage.setItem('livres', JSON.stringify(data.livres));
}


if (!localStorage.getItem('livresSupprimes')) {
    localStorage.setItem('livresSupprimes', JSON.stringify([]));
}


let currentPage = 1;
const booksPerPage = 4;




function afficherLivres(page) {
    let container = document.querySelector(".book-container");
    container.innerHTML = '';


    let livres = JSON.parse(localStorage.getItem('livres')) || []; // Utilisation de '|| []' pour éviter une erreur si localStorage est vide
    let livresSupprimes = JSON.parse(localStorage.getItem('livresSupprimes')) || [];

 
    let livresAffiches = livres.filter(livre => !livresSupprimes.includes(livre.titre));


    let startIndex = (page - 1) * booksPerPage;
    let endIndex = startIndex + booksPerPage;


    let livresPage = livresAffiches.slice(startIndex, endIndex);


    livresPage.forEach(item => {
        let html = `
            <div class="one-book">
                <img src="${item.image}" alt="livre">
                <div class="global">
                    <p class="titre">Titre : ${item.titre}</p>
                    <p class="auteur">Auteur : ${item.auteurs}</p>
                    <p class="disponibilite">Disponibilité : ${item.disponibilite}</p>
                    <div class="button-container">
                        <div class="send-button" onclick="voirDetails('${item.titre}')">Détails</div>
                        <div class="reset-button-container">
                            <div class="reset-button" onclick="supprimerLivre('${item.titre}')">Supprimer</div>
                        </div>
                    </div>              
                </div>
            </div>
        `;

        container.innerHTML += html;
    });

    afficherPagination(livresAffiches.length, page);
}


function afficherPagination(totalLivres, currentPage) {
    let totalPages = Math.ceil(totalLivres / booksPerPage);
    let paginationContainer = document.querySelector(".pagination");

    paginationContainer.innerHTML = '';


    let prevButton = `<button onclick="prevPage()" class="send-button">Précédent</button>`;
    paginationContainer.innerHTML += prevButton;


    for (let i = 1; i <= totalPages; i++) {
        let pageButton = `<button onclick="goToPage(${i})" ${i === currentPage ? 'class="active reset-button"' : ''} class="reset-button">${i}</button>`;
        paginationContainer.innerHTML += pageButton;
    }


    let nextButton = `<button onclick="nextPage()" class="send-button">Suivant</button>`;
    paginationContainer.innerHTML += nextButton;
}



function nextPage() {
    currentPage++;
    afficherLivres(currentPage);
}


function prevPage() {
    if (currentPage > 1) {
        currentPage--;
        afficherLivres(currentPage);
    }
}

function goToPage(page) {
    currentPage = page;
    afficherLivres(currentPage);
}


afficherLivres(currentPage);


function supprimerLivre(titre) {

    let livres = JSON.parse(localStorage.getItem('livres'));
    let livresSupprimes = JSON.parse(localStorage.getItem('livresSupprimes'));


    livres = livres.filter(livre => livre.titre !== titre);


    livresSupprimes.push(titre);

    localStorage.setItem('livres', JSON.stringify(livres));
    localStorage.setItem('livresSupprimes', JSON.stringify(livresSupprimes));

    afficherLivres(currentPage);
}


function voirDetails(str) {
    const livre = JSON.parse(localStorage.getItem('livres')).find(item => item.titre === str);
    if (livre) {
        let container = document.querySelector(".details");
        let html = `
            <div class="details-title">
                <h3>Détails</h3>
                <button class="close btn" onclick="closeDetails()">Fermer</button>
            </div>
            <div class="proprietes">
                <div class="titre-livre">Titre : ${livre.titre}</div>
                <div class="auteur">Auteur : ${livre.auteurs}</div>
                <div class="genre">Genre : ${livre.genre}</div>
                <div class="etat">État : ${livre.etat}</div>
                <div class="disponibilite">Disponibilité : ${livre.disponibilite}</div>
                <div class="isbn">ISBN : ${livre.isbn}</div>
                <div class="editeur">Éditeur : ${livre.editeur}</div>
                <div class="datePublication">Date de publication : ${livre.datePublication}</div>
                <div class="langue">Langue : ${livre.langue}</div>
                <div class="nombrePages">Nombre de pages : ${livre.nombrePages}</div>
                <div class="emplacement">Emplacement : ${livre.emplacement}</div>
            </div>
            <div class="resume">
                <p><u>Résumé</u></p>
                <p>${livre.resume}</p>
            </div>
        `;
        container.innerHTML = html;
        container.style.display = 'block';
    }
}


function closeDetails() {
    let container = document.querySelector(".details");
    container.style.display = 'none';
}



function afficherLivresParCategorie(categorie) {
    let container = document.querySelector(".book-container");
    container.innerHTML = ''; 


    let livres = JSON.parse(localStorage.getItem('livres')) || [];


    if (categorie === 'Tout') {
        livres.forEach(item => {
            let html = `
                <div class="one-book">
                    <img src="${item.image}" alt="livre">
                    <div class="global">
                        <p class="titre">Titre : ${item.titre}</p>
                        <p class="auteur">Auteur : ${item.auteurs}</p>
                        <p class="disponibilite">Disponibilité : ${item.disponibilite}</p>
                        <div class="button-container">
                            <div class="send-button" onclick="voirDetails('${item.titre}')">Détails</div>
                            <div class="reset-button-container">
                                <div class="reset-button" onclick="supprimerLivre('${item.titre}')">Supprimer</div>
                            </div>
                        </div>              
                    </div>
                </div>
            `;

            container.innerHTML += html;
        });
    } else {

        livres.filter(item => {

            let genres = item.genre.split(',').map(genre => genre.trim());

            return genres.includes(categorie);
        }).forEach(item => {
            let html = `
                <div class="one-book">
                    <img src="${item.image}" alt="livre">
                    <div class="global">
                        <p class="titre">Titre : ${item.titre}</p>
                        <p class="auteur">Auteur : ${item.auteurs}</p>
                        <p class="disponibilite">Disponibilité : ${item.disponibilite}</p>
                        <div class="button-container">
                            <div class="send-button" onclick="voirDetails('${item.titre}')">Détails</div>
                            <div class="reset-button-container">
                                <div class="reset-button" onclick="supprimerLivre('${item.titre}')">Supprimer</div>
                            </div>
                        </div>              
                    </div>
                </div>
            `;

            container.innerHTML += html;
        });
    }
}


document.querySelectorAll('.categorie-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        let categorie = this.getAttribute('data-categorie');
        afficherLivresParCategorie(categorie);
    });
});


window.onload = function() {
    afficherLivresParCategorie('Tout');
};



document.getElementById('add-button').addEventListener('click', function() {
    // Récupérer les valeurs des champs du formulaire
    let titre = document.getElementById('add-titre').value.trim();
    let auteurs = document.getElementById('add-auteur').value.trim();
    let isbn = document.getElementById('add-isbn').value.trim();
    let image = document.getElementById('add-image').value.trim();
    let editeur = document.getElementById('add-editeur').value.trim();
    let datePublication = document.getElementById('add-date').value;
    let genre = document.getElementById('add-genre').value;
    let langue = document.getElementById('add-langue').value;
    let nombrePages = parseInt(document.getElementById('add-page').value.trim());
    let disponibilite = document.getElementById('add-dispo').value.trim();
    let etat = document.getElementById('add-etat').value.trim();
    let emplacement = document.getElementById('add-emplacement').value.trim();
    let resume = document.getElementById('resume').value.trim();


    if (titre === '' || auteurs === '' || isbn === '' || image === '' || editeur === '' || datePublication === '' || genre === '' || langue === '' || isNaN(nombrePages) || disponibilite === '' || etat === '' || emplacement === '' || resume === '') {
        alert("Veuillez remplir tous les champs du formulaire.");
        return;
    }


    let nouveauLivre = {
        titre: titre,
        auteurs: auteurs,
        isbn: isbn,
        image: image,
        editeur: editeur,
        datePublication: datePublication,
        genre: genre,
        langue: langue,
        nombrePages: nombrePages,
        disponibilite: disponibilite,
        etat: etat,
        emplacement: emplacement,
        resume: resume
    };


    let livres = JSON.parse(localStorage.getItem('livres')) || [];


    livres.push(nouveauLivre);


    localStorage.setItem('livres', JSON.stringify(livres));


    afficherLivres();


    document.getElementById('add-titre').value = '';
    document.getElementById('add-auteur').value = '';
    document.getElementById('add-isbn').value = '';
    document.getElementById('add-image').value = '';
    document.getElementById('add-editeur').value = '';
    document.getElementById('add-date').value = '';
    document.getElementById('add-genre').value = '';
    document.getElementById('add-langue').value = '';
    document.getElementById('add-page').value = '';
    document.getElementById('add-dispo').value = '';
    document.getElementById('add-etat').value = '';
    document.getElementById('add-emplacement').value = '';
    document.getElementById('resume').value = '';
});


document.getElementById('reset-btn').addEventListener('click', function() {
    document.getElementById('add-titre').value = '';
    document.getElementById('add-auteur').value = '';
    document.getElementById('add-isbn').value = '';
    document.getElementById('add-image').value = '';
    document.getElementById('add-editeur').value = '';
    document.getElementById('add-date').value = '';
    document.getElementById('add-genre').value = '';
    document.getElementById('add-langue').value = '';
    document.getElementById('add-page').value = '';
    document.getElementById('add-dispo').value = '';
    document.getElementById('add-etat').value = '';
    document.getElementById('add-emplacement').value = '';
    document.getElementById('resume').value = '';
});





const searchTitre = document.getElementById('search-titre');
const searchAuteur = document.getElementById('search-auteur');
const searchDateMin = document.getElementById('search-date-min');
const searchDateMax = document.getElementById('search-date-max');
const searchPagesMin = document.getElementById('search-pages-min');
const searchPagesMax = document.getElementById('search-pages-max');
const searchDispo = document.getElementById('search-dispo');
const searchButton = document.getElementById('search-button');


searchButton.addEventListener('click', () => {

    let titre = searchTitre.value.trim().toLowerCase();
    let auteur = searchAuteur.value.trim().toLowerCase();
    let dateMin = parseInt(searchDateMin.value) || 0;
    let dateMax = parseInt(searchDateMax.value) || Infinity;
    let pagesMin = parseInt(searchPagesMin.value) || 0;
    let pagesMax = parseInt(searchPagesMax.value) || Infinity;
    let dispo = searchDispo.value;


    let livres = JSON.parse(localStorage.getItem('livres')) || [];


    let livresSupprimes = JSON.parse(localStorage.getItem('livresSupprimes')) || [];


    let resultats = livres.filter(livre => {

        if (livresSupprimes.includes(livre.titre)) return false;

        if (titre && !livre.titre.toLowerCase().includes(titre)) return false;
        if (auteur && !livre.auteurs.toLowerCase().includes(auteur)) return false;
        

        let datePublication = parseInt(livre.datePublication);
        if (datePublication < dateMin || datePublication > dateMax) return false;
        

        let nombrePages = livre.nombrePages;
        if (nombrePages < pagesMin || nombrePages > pagesMax) return false;
        

        if (dispo && livre.disponibilite !== dispo) return false;

        return true;
    });


    afficherResultats(resultats);
});

function afficherResultats(resultats) {
    let container = document.querySelector(".book-container");
    container.innerHTML = '';

    if (resultats.length === 0) {
        container.innerHTML = `<p>Aucun résultat trouvé.</p>`;
        return;
    }


    resultats.forEach(item => {
        let html = `
            <div class="one-book">
                <img src="${item.image}" alt="livre">
                <div class="global">
                    <p class="titre">Titre : ${item.titre}</p>
                    <p class="auteur">Auteur : ${item.auteurs}</p>
                    <p class="disponibilite">Disponibilité : ${item.disponibilite}</p>
                    <div class="button-container">
                        <div class="send-button" onclick="voirDetails('${item.titre}')">Détails</div>
                        <div class="reset-button-container">
                            <div class="reset-button" onclick="supprimerLivre('${item.titre}')">Supprimer</div>
                        </div>
                    </div>              
                </div>
            </div>
        `;
        container.innerHTML += html;
    });
}


function resetSearch() {
    searchTitre.value = '';
    searchAuteur.value = '';
    searchDateMin.value = '';
    searchDateMax.value = '';
    searchPagesMin.value = '';
    searchPagesMax.value = '';
    searchDispo.value = '';

    afficherLivres(currentPage);
}


function goToPage(page) {
    currentPage = page;
    afficherLivres(currentPage);
}

window.onload = function() {
    afficherLivres(currentPage);
};

